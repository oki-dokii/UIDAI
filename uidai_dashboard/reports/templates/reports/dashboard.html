{% extends 'reports/base.html' %}
{% load static %}

{% block title %}Dashboard - UIDAI Hackathon 2026{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="display-5 fw-bold">
            <span class="text-primary">UIDAI</span> Data Hackathon 2026
        </h1>
        <p class="lead">Unlocking Societal Trends in Aadhaar Enrolment & Updates</p>
    </div>

    <!-- KPI Cards Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card card border-left-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-primary">Total Enrolments</div>
                            <div class="metric-value">{{ metrics.total_enrolments|floatformat:0|default:"5.4M" }}</div>
                        </div>
                        <div class="metric-icon text-primary">
                            <i class="bi bi-person-plus-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card card border-left-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-success">Demographic Updates</div>
                            <div class="metric-value">{{ metrics.total_demo_updates|floatformat:0|default:"49.3M" }}
                            </div>
                        </div>
                        <div class="metric-icon text-success">
                            <i class="bi bi-file-text-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card card border-left-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-warning">Biometric Updates</div>
                            <div class="metric-value">{{ metrics.total_bio_updates|floatformat:0|default:"69.8M" }}
                            </div>
                        </div>
                        <div class="metric-icon text-warning">
                            <i class="bi bi-fingerprint"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card card border-left-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-info">Update:Enrol Ratio</div>
                            <div class="metric-value">{{ metrics.update_to_enrol_ratio|floatformat:1|default:"21.9" }}x
                            </div>
                        </div>
                        <div class="metric-icon text-info">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Second KPI Row -->
    <div class="row mb-4">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="metric-card card border-left-danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-danger">Child Attention Gap</div>
                            <div class="metric-value">{{ metrics.child_attention_gap|floatformat:2|default:"-0.23" }}
                            </div>
                        </div>
                        <div class="metric-icon text-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                    </div>
                    <small class="text-muted">Negative = children under-served</small>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="metric-card card border-left-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-primary">States Analyzed</div>
                            <div class="metric-value">{{ metrics.states_analyzed|default:"54" }}</div>
                        </div>
                        <div class="metric-icon text-primary">
                            <i class="bi bi-map-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="metric-card card border-left-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label text-success">Districts Analyzed</div>
                            <div class="metric-value">{{ metrics.districts_analyzed|default:"1,041" }}</div>
                        </div>
                        <div class="metric-icon text-success">
                            <i class="bi bi-geo-alt-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8">
            <div class="chart-card card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0"><i class="bi bi-graph-up me-2"></i>National Trends: Enrolments vs Updates</h6>
                </div>
                <div class="card-body">
                    <canvas id="nationalTrendChart" height="120"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="chart-card card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-bar-chart-fill me-2"></i>Child Attention Gap by State</h6>
                </div>
                <div class="card-body">
                    <canvas id="childGapChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- State Comparison Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-card card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-bar-chart-steps me-2"></i>Top 10 States by Enrolment</h6>
                </div>
                <div class="card-body">
                    <canvas id="stateComparisonChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="chart-card card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-lightbulb-fill me-2"></i>Key Insights</h6>
                </div>
                <div class="card-body">
                    {% for insight in insights %}
                    <div class="insight-card {{ insight.type }}">
                        <div class="d-flex align-items-start">
                            <span class="insight-icon">{{ insight.icon }}</span>
                            <div>
                                <div class="insight-title">{{ insight.title }}</div>
                                <div class="insight-text">{{ insight.text }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="insight-card info">
                        <div class="d-flex align-items-start">
                            <span class="insight-icon">ðŸ“Š</span>
                            <div>
                                <div class="insight-title">21.9x Update-to-Enrolment Ratio</div>
                                <div class="insight-text">For every new Aadhaar enrolment, there are 22 updates. The
                                    ecosystem is update-driven.</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-pie-chart-fill me-2"></i>Update Composition</h6>
                </div>
                <div class="card-body">
                    <canvas id="updateCompositionChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- State Table -->
    <div class="row">
        <div class="col-12">
            <div class="chart-card card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0"><i class="bi bi-table me-2"></i>State-Level Metrics</h6>
                    <a href="#" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download me-1"></i>Export CSV
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        {{ state_table|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Parse chart data from Django context
    const chartData = {{ chart_data| safe }};

    // National Trend Chart
    const nationalCtx = document.getElementById('nationalTrendChart');
    if (nationalCtx && chartData.national_trend) {
        new Chart(nationalCtx, {
            type: 'line',
            data: chartData.national_trend,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                }
            }
        });
    } else {
        // Fallback demo data
        new Chart(nationalCtx, {
            type: 'line',
            data: {
                labels: ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [
                    {
                        label: 'Enrolments',
                        data: [17000, 257000, 184000, 216000, 617000, 500000, 1476000, 818000, 1092000, 760000],
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Demo Updates',
                        data: [11147000, 1516000, 1566000, 1686000, 2221000, 3000000, 7324000, 5011000, 9388000, 9437000],
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Bio Updates',
                        data: [8322000, 8642000, 7880000, 7899000, 9793000, 8000000, 6655000, 4583000, 7286000, 8704000],
                        borderColor: '#f6c23e',
                        backgroundColor: 'rgba(246, 194, 62, 0.1)',
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                }
            }
        });
    }

    // Child Gap Chart
    const childGapCtx = document.getElementById('childGapChart');
    if (childGapCtx) {
        new Chart(childGapCtx, {
            type: 'bar',
            data: chartData.child_gap || {
                labels: ['UP', 'Bihar', 'MP', 'Rajasthan', 'MH', 'WB', 'Gujarat', 'TN', 'Assam', 'Karnataka'],
                datasets: [{
                    label: 'Child Gap',
                    data: [-0.18, -0.12, -0.25, -0.15, -0.22, -0.30, -0.20, -0.28, -0.10, -0.24],
                    backgroundColor: function (context) {
                        return context.raw > 0 ? '#1cc88a' : '#e74a3b';
                    }
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                plugins: { legend: { display: false } }
            }
        });
    }

    // State Comparison Chart
    const stateCtx = document.getElementById('stateComparisonChart');
    if (stateCtx) {
        new Chart(stateCtx, {
            type: 'bar',
            data: chartData.state_comparison || {
                labels: ['UP', 'Bihar', 'MP', 'West Bengal', 'Maharashtra', 'Rajasthan', 'Gujarat', 'Assam', 'Karnataka', 'Tamil Nadu'],
                datasets: [{
                    label: 'Total Enrolments',
                    data: [1018629, 609585, 493970, 375308, 369139, 348458, 280549, 230197, 223235, 220789],
                    backgroundColor: '#4e73df'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update Composition Pie Chart
    const compCtx = document.getElementById('updateCompositionChart');
    if (compCtx) {
        new Chart(compCtx, {
            type: 'doughnut',
            data: {
                labels: ['Biometric', 'Demographic'],
                datasets: [{
                    data: [58.6, 41.4],
                    backgroundColor: ['#f6c23e', '#1cc88a']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
</script>
{% endblock %}