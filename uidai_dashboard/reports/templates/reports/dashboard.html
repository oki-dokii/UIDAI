{% extends 'reports/base.html' %}
{% load static %}

{% block title %}Executive Dashboard - UIDAI 2026{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h6 class="text-uppercase text-muted fw-bold mb-1">Overview</h6>
            <h2 class="fw-bold text-dark m-0">Societal Trends Dashboard</h2>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white shadow-sm"><i class="bi bi-calendar3 me-2"></i>2025-2026</button>
            <button class="btn btn-primary shadow-sm"><i class="bi bi-download me-2"></i>Export Report</button>
        </div>
    </div>

    <!-- KPI Row -->
    <div class="row g-4 mb-4">
        <!-- Enrolments -->
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-primary h-100">
                <div class="card-body">
                    <div class="metric-label">Total Enrolments</div>
                    <div class="metric-value">{{ metrics.total_enrolments|floatformat:0 }}</div>
                    <div class="d-flex align-items-center mt-2">
                        <span class="badge bg-soft-success text-success me-2">
                            <i class="bi bi-arrow-up-short"></i> 12.5%
                        </span>
                        <span class="text-muted small">vs last month</span>
                    </div>
                    <i class="bi bi-person-plus-fill metric-icon text-primary"></i>
                </div>
            </div>
        </div>

        <!-- Updates -->
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-warning h-100">
                <div class="card-body">
                    <div class="metric-label">Total Updates</div>
                    <div class="metric-value">{{ metrics.total_updates|floatformat:0 }}</div>
                    <div class="d-flex align-items-center mt-2">
                        <span class="badge bg-soft-primary text-primary me-2">
                            <i class="bi bi-activity"></i> High Vol
                        </span>
                        <span class="text-muted small">Biometric led</span>
                    </div>
                    <i class="bi bi-fingerprint metric-icon text-warning"></i>
                </div>
            </div>
        </div>

        <!-- Ratio -->
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-info h-100">
                <div class="card-body">
                    <div class="metric-label">Update:Enrol Ratio</div>
                    <div class="metric-value">{{ metrics.update_to_enrol_ratio|floatformat:1 }}x</div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 85%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block">Target: 15-20x</small>
                    <i class="bi bi-arrow-left-right metric-icon text-info"></i>
                </div>
            </div>
        </div>

        <!-- Child Gap -->
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-danger h-100">
                <div class="card-body">
                    <div class="metric-label">Child Attention Gap</div>
                    <div class="metric-value text-danger">{{ metrics.child_attention_gap|floatformat:2 }}</div>
                    <div class="d-flex align-items-center mt-2">
                        <i class="bi bi-exclamation-circle-fill text-danger me-1"></i>
                        <span class="text-danger small fw-bold">Critical Alert</span>
                    </div>
                    <i class="bi bi-emoji-frown-fill metric-icon text-danger"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="row g-4 mb-4">
        <!-- National Trend -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">National Enrollment vs Update Trends</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button"><i
                                class="bi bi-three-dots-vertical"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="nationalTrendChart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Composition Donut -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="m-0">Update Composition</h5>
                </div>
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="updateCompositionChart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="row">
                            <div class="col-6 border-end">
                                <h4 class="fw-bold mb-0 text-warning">58.6%</h4>
                                <small class="text-muted text-uppercase">Biometric</small>
                            </div>
                            <div class="col-6">
                                <h4 class="fw-bold mb-0 text-success">41.4%</h4>
                                <small class="text-muted text-uppercase">Demographic</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Weekend Paradox -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="m-0">The Weekend Paradox</h5>
                </div>
                <div class="card-body">
                    <canvas id="weekendParadoxChart" height="200"></canvas>
                    <p class="mt-3 small text-muted text-center">
                        <i class="bi bi-info-circle"></i> Service patterns diverge significantly on weekends.
                    </p>
                </div>
            </div>
        </div>

        <!-- Child Gap by State -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="m-0">Child Attention Gap by State</h5>
                </div>
                <div class="card-body">
                    <canvas id="childGapChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Data Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">State Performance Matrix</h5>
                    <button class="btn btn-sm btn-outline-primary"><i class="bi bi-arrows-fullscreen"></i> Full
                        View</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <!-- We render the table manually to add classes -->
                        {% autoescape off %}
                        <table class="table table-hover table-datatable align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th>State</th>
                                    <th>Total Enrol</th>
                                    <th>Updates</th>
                                    <th>Gap</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Python context 'state_table' generates raw HTML; we can inspect/parse or just rely on CSS -->
                                <!-- For better control, let's assume we iterate if possible, or script injects styling. 
                                    Since we passed raw HTML table, let's wrap it nicely. -->
                            </tbody>
                        </table>
                        <!-- Actually the context sends a full table html. Let's output it but we might need to use JS to styling it if it lacks classes -->
                        <div id="state-table-container">
                            {{ state_table }}
                        </div>
                        {% endautoescape %}
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    const chartData = {{ chart_data| safe }};

    // 1. National Trend (Area/Line)
    new Chart(document.getElementById('nationalTrendChart'), {
        type: 'line',
        data: chartData.national_trend,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            tension: 0.4,
            plugins: {
                legend: { position: 'top', align: 'end' },
                tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false },
            scales: {
                y: {
                    grid: { borderDash: [2, 4] },
                    ticks: { callback: (val) => val / 1000000 + 'M' }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // 2. Composition (Doughnut)
    new Chart(document.getElementById('updateCompositionChart'), {
        type: 'doughnut',
        data: {
            labels: ['Biometric', 'Demographic'],
            datasets: [{
                data: [58.6, 41.4],
                backgroundColor: ['#f6c23e', '#4cc9f0'], // Contrast colors
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: { legend: { display: false } }
        }
    });

    // 3. Weekend Paradox (Bar)
    if (chartData.weekend_paradox) {
        new Chart(document.getElementById('weekendParadoxChart'), {
            type: 'bar',
            data: chartData.weekend_paradox,
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 2] } }
                }
            }
        });
    }

    // 4. Child Gap (Bar - Horizontal)
    new Chart(document.getElementById('childGapChart'), {
        type: 'bar',
        data: chartData.child_gap,
        options: {
            indexAxis: 'x', // Vertical bars
            responsive: true,
            scales: {
                y: {
                    grid: { color: (ctx) => ctx.tick.value === 0 ? '#666' : 'rgba(0,0,0,0.05)', lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1 }
                },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });

    // Fix table styling via JS
    $(document).ready(function () {
        $('#state-table-container table').addClass('table table-hover table-striped mb-0');
        // Initialize DataTables if not already (the base template does it on .table-datatable)
        $('#state-table-container table').DataTable({
            "pageLength": 5,
            "lengthMenu": [5, 10, 25],
            "order": [[1, "desc"]] // Sort by 2nd column (Enrolment) desc
        });
    });
</script>
{% endblock %}